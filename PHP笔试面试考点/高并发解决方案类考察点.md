- [1.高并发架构相关概念](#gn)
- [2.高并发解决方案案例](#al)
- [3.高并发方案详细说明](#sm)
# <a id="gn">高并发架构相关概念</a>  
1. __什么是高并发：__  
在互联网时代，所讲的并发、高并发，通常是指并发访问。也就是在某个时间点，有多少个访问同时到来。通常如果一个系统的日PV在千万以上，有可能是一个高并发的系统，有的公司完全不走技术路线，全靠机器堆，这不在我们的讨论范围内。  
2.  __高并发的问题我们具体该关心什么？__  
__QPS__: 每秒钟请求或者查询的数量，在互联网领域，指的是每秒响应请求数（指的是HTTP请求）;  
__吞吐率__: 单位时间内服务器处理的请求数量，通常使用“reqs/s”来表示。我们关心的是最大吞吐率（通常由QPS与并发数决定）  
__响应时间__: 从请求发出到收到响应花费的时间。例如系统处理一个HTTP请求需要100ms,这个100ms就是系统的响应时间。  
__PV__: 综合浏览量(Page View),即页面浏览量或者点击量，一个访客在24小时内访问的页面数量。同一个人浏览你的网站的同一页面，只记作一次PV。 多次刷新同一页面只算一次。根据日均pv可以计算出峰值qps.   
__UV__: 独立访客（Unique Visitor）,即一定时间范围内相同访客多次访问网站，只计算为1个独立访客。  
__带宽__:计算带宽大小需要关注两个指标，峰值流量和页面的平均大小
    >     日网站带宽 = PV/统计时间（换算到秒）*平均页面大小（单位KB）*8
    >     峰值一般是平均值的倍数，根据实际情况来定  

    >     注意：QPS不等于并发连接数；QPS是每秒HTTP请求的数量，并发连接数是系统同时处理请求数量。 

    >     峰值每秒请求数（QPS）= （总PV数*80%）*（6小时秒数*20%）
    >     80%的访问量集中在20%的访问时间  
2.  __压力测试:__  
__常用性能测试工具__ ：ab、wrk、http_load、Web Bench、Siege、Apache JMeter  
__ab__ :全称是apache benchmark,是apache官方推出的工具创建多个并发访问线程，模拟多个访问者同时对某一个URL地址进行访问。它的测试目标基于URL，因此它既可以用来测试apache的负载压力，也可以测试nginx、lighthttp、tomcat、IIS等其他Web服务器的压力。  
__ab的使用__ :模拟并发请求100次，总共请求5000次。  
    >     ab -c 100 -n 5000 待测试的网站

__ab使用注意事项__ : 测试机器与被测试机器分开；不要对线上服务做压力测试；观察测试工具ab所在的机器，以及被测试的前下·端机的CPU，内存，网络等都不超过最高限度的75%。  
__QPS达到极限__：  
随着QPS的增长，每个阶段的需要根据实际情况来进行优化，优化的方案也与硬件条件、网络带宽息息相关。  
__QPS达到50__：  
可以称之为小型网站，一般的服务器就可以应付。  
__QPS达到100__：  
假设关系型数据库每次请求在0.01秒完成。假设单个页面只有一个SQL查询，那么100QPS意味着1秒钟完成100次请求，但是此时我们并不能保证数据库查询能完成100次。  
方案：数据库缓存层、数据库的负载均衡。  
__QPS达到800__：  
假设我们使用百兆带宽，意味着网站出口的实际带宽是8M左右，假设每个页面只有10K，在这个并发条件下，百兆带宽已经吃完。  
方案：CDN加速、负载均衡。   
__QPS达到1000__：  
假设使用Memcache缓存数据库查询数据，每个页面对Memcache的请求远大于直接对DB的请求；Memcache的悲观并发数在2w左右，但有可能在之前内网带宽已经吃光，表现出不稳定。  
方案：静态HTML缓存。  
__QPS达到2000__：  
这个级别下，文件系统访问锁都成了灾难。  
方案：做业务分离，分布式存储。  
# <a id="al">高并发解决方案案例</a>   
1. __流量优化__  
防盗链处理  
2. __前端优化__  
减少http请求（例如合并js、css文件）  
添加异步请求（不要一次请拿到数据） 
启用浏览器缓存和文件压缩  
CDN加速（就近访问，解决带宽不够用问题）  
建立独立的图片服务器(吃io,针对性优化（磁盘优化）)  
3. __服务端优化__  
页面静态化（直接缓存成html页面）  
（穿透了静态化、实时性要求比较高）并发处理(多线程进程异步处理、队列处理)  
4. __数据库优化__  
数据库缓存  
分库分表、分区操作  
读写分离  
负载均衡  
5. __Web服务器优化__  
负载均衡  
# <a id="sm">高并发方案详细说明</a>  
1. Web资源防盗链  
2. 减少HTTP请求次数  
__为什么减少HTTP请求__：  
__(1)性能黄金法则：__只有10%-20%的最终用户响应时间花在接受请求的HTML文档上，剩下80%-90%的时间花在HTML文档所引用的所有组件（图片，script,css,flash等等） 进行的HTTP请求上。  
__(2)如何改善:__改善响应时间的最简单途径就是减少组件的数量，并由此减少HTTP请求的数量。  
__(3)HTTP连接产生的开销：__域名解析--TCP连接--发送请求--等待--下载资源--解析时间。  
__(4)疑问？__DNS缓存；Keep-Alive。  
__(5)打破谣言:__查找DNS缓存也需要时间，多个缓存就要查找多次有可能缓存被清除。HTTP1.1协议规定请求只能串行发送，也就是一百个请求必须逐个发送，前面一个请求完成才能开始下一个请求。  
__减少HTTP请求的方式__  
__(1)图片地图:__图片地图允许你在一个图片上关联多个URL。目标URL的选择取决于用户单击了图片上的哪个位置。我们通  
![](https://github.com/MAZENAN/lear_note/blob/master/PHP%E7%AC%94%E8%AF%95%E9%9D%A2%E8%AF%95%E8%80%83%E7%82%B9/img/img_map.png)
