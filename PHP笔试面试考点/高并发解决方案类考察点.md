- [1.高并发架构相关概念](#gn)
# <a id="gn">高并发架构相关概念</a>  
1. __什么是高并发：__  
在互联网时代，所讲的并发、高并发，通常是指并发访问。也就是在某个时间点，有多少个访问同时到来。通常如果一个系统的日PV在千万以上，有可能是一个高并发的系统，有的公司完全不走技术路线，全靠机器堆，这不在我们的讨论范围内。  
2.  __高并发的问题我们具体该关心什么？__  
__QPS__: 每秒钟请求或者查询的数量，在互联网领域，指的是每秒响应请求数（指的是HTTP请求）;  
__吞吐率__: 单位时间内服务器处理的请求数量，通常使用“reqs/s”来表示。我们关心的是最大吞吐率（通常由QPS与并发数决定）  
__响应时间__: 从请求发出到收到响应花费的时间。例如系统处理一个HTTP请求需要100ms,这个100ms就是系统的响应时间。  
__PV__: 综合浏览量(Page View),即页面浏览量或者点击量，一个访客在24小时内访问的页面数量。同一个人浏览你的网站的同一页面，只记作一次PV。 多次刷新同一页面只算一次。根据日均pv可以计算出峰值qps.   
__UV__: 独立访客（Unique Visitor）,即一定时间范围内相同访客多次访问网站，只计算为1个独立访客。  
__带宽__:计算带宽大小需要关注两个指标，峰值流量和页面的平均大小
    >     日网站带宽 = PV/统计时间（换算到秒）*平均页面大小（单位KB）*8
    >     峰值一般是平均值的倍数，根据实际情况来定  

    >     注意：QPS不等于并发连接数；QPS是每秒HTTP请求的数量，并发连接数是系统同时处理请求数量。 

    >     峰值每秒请求数（QPS）= （总PV数*80%）*（6小时秒数*20%）
    >     80%的访问量集中在20%的访问时间  
2.  __压力测试:__  
__常用性能测试工具__ ：ab、wrk、http_load、Web Bench、Siege、Apache JMeter  
__ab__ :全称是apache benchmark,是apache官方推出的工具创建多个并发访问线程，模拟多个访问者同时对某一个URL地址进行访问。它的测试目标基于URL，因此它既可以用来测试apache的负载压力，也可以测试nginx、lighthttp、tomcat、IIS等其他Web服务器的压力。  
__ab的使用__ :模拟并发请求100次，总共请求5000次。  
    >     ab -c 100 -n 5000 待测试的网站

__ab使用注意事项__ : 测试机器与被测试机器分开；不要对线上服务做压力测试；观察测试工具ab所在的机器，以及被测试的前下·端机的CPU，内存，网络等都不超过最高限度的75%。  
__QPS达到极限__：  
随着QPS的增长，每个阶段的需要根据实际情况来进行优化，优化的方案也与硬件条件、网络带宽息息相关。  
__QPS达到50__：  
可以称之为小型网站，一般的服务器就可以应付。  
__QPS达到100__：  
假设关系型数据库每次请求在0.01秒完成。假设单个页面只有一个SQL查询，那么100QPS意味着1秒钟完成100次请求，但是此时我们并不能保证数据库查询能完成100次。  
方案：数据库缓存层、数据库的负载均衡。  
__QPS达到800__：  
假设我们使用百兆带宽，意味着网站出口的实际带宽是8M左右，假设每个页面只有10K，在这个并发条件下，百兆带宽已经吃完。  
方案：CDN加速、负载均衡。   
__QPS达到1000__：  
假设使用Memcache缓存数据库查询数据，每个页面对Memcache的请求远大于直接对DB的请求；Memcache的悲观并发数在2w左右，但有可能在之前内网带宽已经吃光，表现出不稳定。  
方案：静态HTML缓存。  
__QPS达到2000__：  
这个级别下，文件系统访问锁都成了灾难。  
方案：做业务分离，分布式存储。