# OAuth 2.0 开放网络授权标准总纲  
## 简介  

- OAuth 2.0 是一个在全球范围得到广泛认可和应用的开放网络授权标准，基于这个标准，各个知名公司的知名产品 Google、FaceBook、GitHub、微信、QQ、微博都使用 OAuth 2.0 标准实现了授权的框架，应用于第三方登录以及其他的授权信息访问的使用场景中，在互联网上我们可以找到非常多的博客对 OAuth 2.0 进行介绍和分析，但是大都只是简单的介绍和入门，我这次会用我自己的视角来解读一下 OAuth 2.0，对于技术人员来说，OAuth 2 这是非常重要的一个网络标准，授权的使用场景也不像很多人想像的那么简单，理解了 OAuth 2.0 的使用场景和不同场景下的不同解决方案后，不管是网络 API 的开发还是将我们服务器中的用户数据或企业数据（服务）（与用户无关的数据或服务）授权给第三方的服务，你都可以搞定，对前后端分离的应用开发在整体上也会有更深入的理解。最后呢，给大家一个建议，不要总跟编程语言死磕，打基础不光是学语言那么简单，编程语言只是告诉我们如何按照语法编码；编程则是需要结合服务构建的底层技术（各种协议和规范）以及编程思想，业务场景进行工作的综合素质的考验。

## 网络授权到底是围绕什么展开的  
- OAuth 诞生时的使用场景举例:  
__小美在 A 网站 “照片仓库” 保存了非常多的照片想打印，可 A 网站却并没有提供照片编辑和相册制作的功能，而 B 网站“美图羞羞”却在相册制作领域格外风骚，但是这个时候由于 A 站和 B 站由于没有数据之间安全访问和协作的机制，小美想要完成相册的制作就很尴尬，她能采取的方案如下：__  

1. 方案一：把照片从 A 站下载下来重新上传到 B 站上。 小美觉得实在太浪费时间，效率太低，简直是对智商的一种侮辱，于是想到第二种方法。  
2. 方案二：把 A 站的账号密码告诉 B 站人员，让 B 站美图羞羞的工作人员替他操作照片的转移工作。  

效率是提升了，安全性却降低了，隐私很可能就暴露了，想到摄影专家陈师傅的遭遇，小美觉得这个方案甚至还比不上第一个解决方案，于是跟小美有同样需求的小美美们开始寻找解决方案。有需求就有商机，重利当头，头破血流，金钱可以使人癫狂，为了获得金钱人却可以理性到极致，这一次面和心不和巨头们（谷歌、雅虎、微软等）第一次坐到一起共商国是，`目的就是为 API 的访问授权提供一个统一开放的标准`，毕竟制订标准和规则这种事情对于任何一家公司来说诱惑力都实在太大了，这可是统治阶级的核心领导层才能干的事。  

在这里划下咱们的第一个重点，这个点极为重要，网络授权目的是为 API 的访问授权提供一个统一开放的标准，有了这个出发点和大前提咱们才能够真正理解 OAuth授权真正的用途，任何标准的提出都不会是简简单单为了解决某一个小需求，小问题，而是在宏观的角度上构建出解决方案，在关键细节上制订好需要共同遵守的规章。网上很多教程都是围绕 “资源授权” 对 OAuth 进行入门介绍的，导致很多人对 OAuth 的理解出现了偏差，所以在这里正本清源，咱们不要再绕着 “资源授权” 这个磨盘转了，“资源授权”只是OAuth某个使用场景下的表现形式，API 才是被 OAuth 进行授权的核心主角。API 才是不同公司的产品间相互调用服务的桥梁，资源是 API 这辆卡车携带的货物。我们使用网络 API 去请求这些资源，授予客户端（app 或者网页应用）能够通过该 API 接口获取或者操作这些资源的权限。以第三方登录为例，表面上看是我授予了某个网站或者应用访问我微信头像和用户名等资源的权限，`在技术层面则是向第三方的应用开启了 API 的访问权限`。  

## 网络授权中的不同角色如何各司其职  
- 前文书我们已经说到 `OAuth 网络授权目的是为 API 的访问授权提供一个统一开放的标准`，这篇图文咱们就看一看参与到网络授权的参与者都有哪些？核心的授权流程是如何进行的？这一次咱们从最复杂的场景出发，也就是上一篇图文当中小美的场景。在这个场景中小美的照片存放在 A 网站 “图片仓库” 中，而 B站 “美图羞羞” 需要 A 站中照片资源，所以希望 A 站能够提供小美账号下的照片以便美图羞羞可以向小美提供相册制作的服务。在这个场景下，参与者如下：  
 
1. __资源的拥有者（Resource Owner） - 用户小美__

2. __被授权的客户端 (Client Application) - B 站美图羞羞__

3. __服务提供商（HTTP Service）- A 站图片仓库__  

毕竟咱们都是技术人员，所以必要的技术名词咱们还是要慢慢引入的，如果从 UML 的方法论来说，我们正在完成从 现实世界到业务模型的转化 过程，我们也正好借着这个机会简单学习一下建模的推导过程，不求严谨，但求把里面最重要的思想传递给大家。目前我们只是简单的提取出了当前授权场景下的参与者，其授权的交互流程尚未得出。现在咱们就来看一看，被授权的客户端美图羞羞都需要获得谁的授权，它需要获得用户小美和 A 站图片仓库的联合授权，而且这个授权的过程是分两步走： 
 
1. __获得用户小美的授权__
2. __获取A站图片仓库的授权，发给B站一个`access_token`令牌__  

经过这两步授权之后，美图羞羞无需用户在A站的用户名和密码，直接拿着令牌（access token）再次到服务提供商 A 站图片仓库那里调用指定的API获取到小美的照片资源。请记住，这是一个权限有限的令牌，使用这个访问令·牌只能调用服务提供商图片仓库允许第三方客户端调用的 API 以获取相应的资源，在这里引出第 4 个核心概念，`权限范围（ scope ）`，在本例中，权限范围就是部分小美允许开放给第三方的照片资源。至此，最基本的几个核心概念咱们都凑齐了。再接下来，就到了系统分拆的阶段，我们知道参与OAuth 规则制订的多是大公司，大公司尤其讲究系统的职责划分。不光编程的时候有单一职责这个指导原则，系统进行设计的时候同样如此。于是乎，它们对服务提供商下手了，为的是更好的管理和更高的安全性，将其划分为以下两个子系统：  

1. __授权/认证服务器 ( Authorization server )__  

2. __资源服务器 ( Resource server )__  

在大公司，这是两套系统，部署在不同的服务器中，而在大部分小型公司则把他们部署在一个服务器甚至一个服务器的同一项目中。OK，接下来就该进入核心部分了，授权和认证的流程，咱们还是先贴一张图吧，这张图很多博客或教程里都出现过：

![oauth2-flow](https://github.com/MAZENAN/lear_note/blob/master/协议/img/oauth2-flow.png)  

这是一张抽象的流程图，它用最抽象的方式表达了授权和认证的过程，很多人看不懂这张图就是因为把它当作了某个场景下的具体实现流程，然而这张图只有抽象的过程，并没有具体授权和认证过程的逻辑，原来不光编程的时候玩抽象，流程图也可以玩抽象，抽象的思维无处不在，因为用好了抽象，可以帮助我们解决各类问题，不管是生活的还是工作的，利器在手，用不用在我们自己～  

OAuth在"客户端"与"服务提供商"之间，设置了一个授权层（authorization layer）。"客户端" 不能直接登录 "服务提供商"，只能通过授权层的授权之后才能访问用户的资源。"客户端" 所用的令牌（token），与用户的账号和密码不同。用户可以在登录的时候，指定授权层令牌的权限范围和有效期。  "服务提供商"根据“客户端令牌”的权限范围和有效期，向"客户端"开放用户储存的资源，我们先来简单把图中核心流程梳理一下：  

__（A）用户打开客户端以后，客户端要求用户给予授权。__

__（B）用户同意给予客户端授权。__ 

__（C）客户端使用上一步获得的授权，向认证服务器申请令牌。__ 

__（D）认证服务器对客户端进行认证以后，确认无误，同意__

__（E）客户端使用令牌，向资源服务器申请获取资源。__ 

__（F）资源服务器确认令牌无误，同意向客户端开放资源。__  

__不难看出来，上面六个步骤之中，B是关键，即用户怎样才能给于客户端授权。有了这个授权以后，客户端就可以获取令牌，进而凭令牌获取资源。__  

但是最后一句话我要进行修改，为什么呢，因为之前咱们说了这是一张抽象流程图，之所以是抽象，那就是因为到了具体场景下具体流程也会表现出“多态”的特性，授权给客户端时，授权方可能是用户和授权服务器联合授权，也可能只有授权服务器在进行授权，压根没有用户什么事。所以这里需要修改为“B是关键，`即如何向客户端进行授权”`。理解了这一点，我们才能够真正理解 OAuth2 提出的四种不同使用场景下的授权模式，在某些场景下，A、B 这两个步骤都是不存在的。上帝啊，又出现“模式”这俩字了，江湖就是如此，小帮派有小讲究，大江湖有大套路，在编程语言层面有设计模式，到了业务层面，也有更高级别的模式。有一套系列技术书籍，现在甚至都很难买齐全套了《面向模式的软件架构》，极为经典，如果你有全套的话，送我可好，我想收藏一套，以娱晚年 ～

客户端必须得到授权（authorization grant），才能获得令牌（access token），OAuth 2 提出了四种授权模式供我们在不同场景下使用：  

- 授权码模式（authorization code）  
- 简化模式（implicit）  
- 密码模式（resource owner password credentials）  
- 客户端模式（client credentials）  

但是最后咱们再次强调两个重点，这两个点切不可理解偏差，会直接影响到后面对各个授权模式的学习和理解的：  

1. OAuth 授权是围绕 API 进行的，是对需要授权的 API 设计的机制，不是针对资源进行的，也不要把那些不需要授权的 开放式 API 跟 OAuth2 授权的 API 混为一谈  

2. 文中所说的 客户端 一定要正确理解，这个客户端与平时理解的前端或者 app 客户端不是一个概念，这里的客户端某些场景下是包含自己的后端服务器的。只是因为在授权的场景下，授权方是服务的提供方，所以授权方是服务提供者，请求人家服务的第三方统一被认定为“客户端”，这是从大的调用关系上对他们的角色进行的划分。不要用日常使用的“客户端”来理解这里的客户端。  

# OAuth 2.0 开放网络授权标准详解  
